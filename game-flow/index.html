<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flow Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');

        /* --- 1. LAYOUT & RESET --- */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            height: 100dvh;
            overflow: hidden;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0;
            font-family: 'Fredoka', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none; /* Mencegah geser layar */
        }

        /* --- 2. SISTEM LAYAR (SAKLAR V5 - PASTI JALAN) --- */
        .game-screen {
            display: none !important; /* Default mati total */
            width: 100%;
            max-width: 480px;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            position: relative;
            z-index: 10;
        }

        .game-screen.active {
            display: flex !important; /* Hidup */
            z-index: 20;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* --- 3. CANVAS & STYLE ASLI --- */
        #game-wrapper {
            padding: 10px;
            background: #1e293b;
            border-radius: 20px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        canvas {
            border-radius: 12px;
            cursor: crosshair;
            display: block;
            touch-action: none;
        }

        /* Efek Glow Tombol */
        .btn-glow { animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 25px rgba(59, 130, 246, 0.8); }
        }

        /* Tombol ditekan */
        button:active { transform: scale(0.95); }

        .hide-scroll::-webkit-scrollbar { display: none; }

        /* Background Hiasan */
        .bg-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.2;
            z-index: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div class="bg-orb bg-blue-600 w-48 h-48 top-0 left-0"></div>
    <div class="bg-orb bg-pink-600 w-48 h-48 bottom-0 right-0"></div>

    <div id="screen-menu" class="game-screen active">
        
        <a href="../index.html" class="absolute top-6 left-6 text-slate-400 hover:text-white flex items-center gap-2 font-semibold no-underline bg-slate-800/50 px-3 py-1 rounded-full z-50 pointer-events-auto">
            <i class="fas fa-arrow-left"></i> Menu
        </a>

        <div class="mb-12 text-center relative z-10">
            <h1 class="text-6xl font-bold tracking-tighter drop-shadow-lg mb-1">
                <span class="text-blue-500">FLOW</span>
            </h1>
            <h1 class="text-6xl font-bold tracking-tighter drop-shadow-lg">
                <span class="text-pink-500">MASTER</span>
            </h1>
            <div class="mt-4">
                <span class="bg-slate-800 px-3 py-1 rounded-full text-xs font-bold border border-slate-700 text-slate-400">CHALLENGE EDITION</span>
            </div>
        </div>

        <div class="w-full max-w-xs space-y-4 relative z-10">
            <button id="btn-play" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 text-white py-4 rounded-2xl font-bold text-xl shadow-xl btn-glow border-b-4 border-blue-800 flex items-center justify-center gap-3">
                <i class="fas fa-play"></i> MAINKAN
            </button>
            
            <button id="btn-leaderboard" class="w-full bg-slate-700 text-white py-4 rounded-2xl font-bold text-lg shadow-lg border-b-4 border-slate-900 flex items-center justify-center gap-3">
                <i class="fas fa-trophy text-yellow-500"></i> TOP SKOR
            </button>
        </div>
        
        <div class="mt-8 text-slate-600 text-xs font-mono relative z-10">
            v9.0 • RESTORED LOGIC • TIMER ON
        </div>
    </div>


    <div id="screen-game" class="game-screen">
        
        <div class="w-full max-w-[420px] mb-2 px-2 flex justify-between items-center">
            <button id="btn-home" class="w-10 h-10 bg-slate-800 rounded-full text-slate-400 border border-slate-700 flex items-center justify-center shadow-lg">
                <i class="fas fa-home"></i>
            </button>
            <h2 class="text-2xl font-bold tracking-wide drop-shadow-md">
                <span class="text-blue-500">FLOW</span><span class="text-pink-500">MASTER</span>
            </h2>
            <div class="w-10"></div> </div>

        <div class="flex flex-wrap justify-center items-center gap-2 sm:gap-4 mb-4 text-sm font-semibold text-slate-400">
            <div class="flex items-center bg-slate-800/80 px-3 py-1.5 rounded-full border border-slate-700">
                LVL <span id="level-num" class="text-white ml-2 text-base font-bold">1</span>
            </div>
            <div class="flex items-center bg-slate-800/80 px-3 py-1.5 rounded-full border border-slate-700">
                MOVES <span id="moves-display" class="text-white ml-2 text-base font-bold">0</span>
            </div>
            <div class="flex items-center bg-slate-800/80 px-3 py-1.5 rounded-full border border-slate-700">
                <i class="fas fa-clock mr-2 text-slate-500"></i>
                <span id="timer-display" class="text-emerald-400 text-base font-bold font-mono">00:00</span>
            </div>
        </div>

        <div id="game-wrapper">
            <canvas id="gameCanvas"></canvas>
        </div>

        <div class="flex gap-4 mt-6 w-full max-w-[420px] px-2">
            <button id="btn-reset" class="flex-1 bg-slate-700 text-white py-3 rounded-2xl font-bold border-b-4 border-slate-900 flex justify-center items-center gap-2 shadow-lg">
                <i class="fas fa-undo"></i> ULANG
            </button>
            <button id="btn-next" class="flex-1 bg-emerald-500 text-white py-3 rounded-2xl font-bold border-b-4 border-emerald-700 flex justify-center items-center gap-2 shadow-lg opacity-50 cursor-not-allowed" disabled>
                LANJUT <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>


    <div id="screen-leaderboard" class="game-screen">
        <h2 class="text-2xl font-bold text-yellow-500 mb-6 flex items-center gap-2">
            <i class="fas fa-trophy"></i> Top Skor
        </h2>
        <div class="bg-slate-800 w-full rounded-2xl border border-slate-700 overflow-hidden flex flex-col shadow-2xl h-[60vh]">
            <div class="grid grid-cols-3 bg-slate-900 p-4 font-bold text-xs uppercase text-slate-400">
                <div class="text-center">Rank</div>
                <div>Player</div>
                <div class="text-right">Level</div>
            </div>
            <div id="leaderboard-list" class="overflow-y-auto p-0 flex-1 hide-scroll"></div>
        </div>
        <button id="btn-close-lb" class="mt-6 px-10 py-3 bg-slate-700 rounded-full font-bold text-white shadow-lg border-b-4 border-slate-900">
            TUTUP
        </button>
    </div>

    <div id="modal-win" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/95 hidden backdrop-blur-sm">
        <div class="bg-slate-800 p-8 rounded-3xl text-center border-2 border-emerald-500 shadow-2xl max-w-sm w-full mx-4">
            <i class="fas fa-check-circle text-6xl text-emerald-500 mb-4 animate-bounce"></i>
            <h2 class="text-3xl font-bold text-white mb-2">Level Selesai!</h2>
            <p class="text-slate-400 mb-6">Waktu: <span id="win-time" class="text-white font-bold">00:00</span></p>
            <button id="btn-modal-next" class="w-full bg-emerald-500 text-white py-4 rounded-xl font-bold text-lg shadow-lg border-b-4 border-emerald-700">
                Level Berikutnya <i class="fas fa-chevron-right ml-1"></i>
            </button>
        </div>
    </div>

    <div id="modal-submit" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/95 hidden backdrop-blur-sm">
        <div class="bg-slate-800 p-8 rounded-3xl text-center border-2 border-blue-500 shadow-2xl max-w-sm w-full mx-4">
            <i class="fas fa-crown text-5xl text-yellow-400 mb-4 animate-bounce"></i>
            <h2 class="text-3xl font-bold text-white mb-2">TAMAT!</h2>
            <div class="text-4xl font-bold text-blue-400 mb-6" id="final-level-display">Lvl 50</div>
            <input type="text" id="player-name-input" placeholder="NAMA ANDA" maxlength="10" class="w-full bg-slate-900 border border-slate-600 rounded-xl p-4 text-white text-center mb-4 uppercase font-bold">
            <button id="btn-submit-score" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg border-b-4 border-blue-800">
                Simpan Rekor
            </button>
        </div>
    </div>


    <script>
        // --- 1. CONFIG & DATA ---
        const CONFIG = {
            colors: {
                1: '#ef4444', 2: '#3b82f6', 3: '#22c55e', 4: '#eab308', 
                5: '#d946ef', 6: '#f97316', 7: '#06b6d4', 8: '#94a3b8'
            },
            gridLine: '#334155',
            bg: '#1e293b'
        };

        const LEVELS = [
            { size: 5, grid: [[1,0,0,0,2],[0,0,0,0,2],[0,3,3,0,0],[4,0,0,0,0],[4,0,1,5,5]] },
            { size: 5, grid: [[4,4,0,0,1],[0,0,3,0,0],[1,0,3,0,0],[5,0,0,0,0],[5,0,0,2,2]] },
            { size: 6, grid: [[1,0,0,2,0,0],[0,0,0,2,0,0],[0,3,4,0,0,0],[0,3,4,0,5,0],[0,0,0,0,5,0],[1,0,0,0,0,0]] },
            { size: 6, grid: [[1,0,0,0,0,1],[0,0,3,3,0,0],[0,0,4,4,0,0],[0,0,0,0,2,2],[0,5,5,0,0,0],[0,0,0,0,0,0]] },
            { size: 7, grid: [[1,0,0,0,0,0,2],[0,0,3,0,0,0,2],[0,0,3,0,4,0,0],[0,5,0,0,4,0,0],[0,5,0,0,0,0,6],[0,0,0,0,0,0,6],[1,0,0,0,0,0,0]] },
            { size: 8, grid: [[1,0,0,0,0,0,2,0],[0,0,3,3,0,0,2,0],[0,0,4,0,0,0,0,0],[0,0,4,0,5,5,0,0],[0,0,0,0,0,0,0,0],[6,6,0,7,7,0,8,8],[0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0]] }
        ];

        // --- 2. GLOBAL VARIABLES ---
        let state = {
            levelIdx: 0,
            grid: [],
            paths: {},
            currentPath: null,
            moves: 0,
            completed: false,
            startTime: 0,
            timerInterval: null
        };
        
        let canvas, ctx, cellSize, gridSize;

        // --- 3. HELPER: BUTTON BINDER (V5 Method) ---
        function bindButton(id, callback) {
            const btn = document.getElementById(id);
            if(btn) {
                // Touchstart agar responsif di HP
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault(); 
                    callback();
                }, {passive: false});
                // Click untuk backup
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    callback();
                });
            }
        }

        // --- 4. INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            // Bind Tombol
            bindButton('btn-play', startGame);
            bindButton('btn-leaderboard', showLeaderboard);
            bindButton('btn-close-lb', () => switchScreen('screen-menu'));
            bindButton('btn-home', () => {
                stopTimer();
                switchScreen('screen-menu');
            });
            bindButton('btn-reset', resetLevel);
            bindButton('btn-next', nextLevel);
            bindButton('btn-modal-next', () => {
                document.getElementById('modal-win').classList.add('hidden');
                nextLevel();
            });
            bindButton('btn-submit-score', submitScore);

            // Setup Canvas
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            initCanvasEvents();
        });

        // --- 5. SCREEN LOGIC ---
        function switchScreen(id) {
            document.querySelectorAll('.game-screen').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'screen-game') {
                setTimeout(resizeCanvas, 50);
            }
        }

        // --- 6. GAME LOGIC ---
        function startGame() {
            state.levelIdx = 0;
            loadLevel(0);
            switchScreen('screen-game');
        }

        function loadLevel(idx) {
            if(idx >= LEVELS.length) {
                showSubmitModal();
                return;
            }
            
            const lvl = LEVELS[idx];
            gridSize = lvl.size;
            resizeCanvas();
            
            // Deep Copy & Reset
            state.grid = JSON.parse(JSON.stringify(lvl.grid));
            state.paths = {};
            state.moves = 0;
            state.completed = false;
            
            // Init Endpoints
            for(let r=0; r<gridSize; r++) {
                for(let c=0; c<gridSize; c++) {
                    const val = state.grid[r][c];
                    if(val > 0) {
                        if(!state.paths[val]) state.paths[val] = [];
                    }
                }
            }
            
            // UI Updates
            document.getElementById('level-num').innerText = idx + 1;
            document.getElementById('moves-display').innerText = 0;
            document.getElementById('btn-next').disabled = true;
            document.getElementById('btn-next').classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('modal-win').classList.add('hidden');
            
            startTimer();
            render();
        }

        function resetLevel() { loadLevel(state.levelIdx); }
        function nextLevel() { state.levelIdx++; loadLevel(state.levelIdx); }

        function resizeCanvas() {
            if(!canvas) return;
            const size = Math.min(window.innerWidth - 32, 400);
            canvas.width = size;
            canvas.height = size;
            canvas.style.width = size + 'px';
            canvas.style.height = size + 'px';
            if(gridSize) cellSize = size / gridSize;
            if(state.grid.length > 0) render();
        }

        // --- 7. INPUT HANDLER (STRICT GRID LOGIC) ---
        function initCanvasEvents() {
            canvas.addEventListener('mousedown', handleStart);
            canvas.addEventListener('mousemove', handleMove);
            window.addEventListener('mouseup', handleEnd);
            
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleStart(e.touches[0]);
            }, {passive: false});
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                handleMove(e.touches[0]);
            }, {passive: false});
            
            window.addEventListener('touchend', handleEnd);
            window.addEventListener('resize', resizeCanvas);
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const c = Math.floor(x / cellSize);
            const r = Math.floor(y / cellSize);
            return {r, c};
        }

        function handleStart(e) {
            if(state.completed) return;
            const p = getPos(e);
            if(isOutOfBounds(p)) return;
            
            // Cek titik awal (harus endpoint atau path yang ada)
            const baseLevel = LEVELS[state.levelIdx].grid;
            const val = baseLevel[p.r][p.c];
            const currentVal = state.grid[p.r][p.c];
            let colorId = val || currentVal;
            
            if(colorId > 0) {
                state.currentPath = colorId;
                state.paths[colorId] = [{r: p.r, c: p.c}]; // Reset path, start here
                updateGridFromPaths();
                render();
            }
        }

        function handleMove(e) {
            if(!state.currentPath || state.completed) return;
            const p = getPos(e);
            if(isOutOfBounds(p)) return;
            
            const path = state.paths[state.currentPath];
            const last = path[path.length-1];
            
            // Jika pindah cell
            if(last.r !== p.r || last.c !== p.c) {
                // LOGIKA KETAT: Hanya boleh atas/bawah/kiri/kanan (Manhattan Distance = 1)
                const dist = Math.abs(last.r - p.r) + Math.abs(last.c - p.c);
                if(dist === 1) {
                    
                    const baseLevel = LEVELS[state.levelIdx].grid;
                    const targetBase = baseLevel[p.r][p.c];     // Base grid (endpoint/kosong)
                    const targetCurrent = state.grid[p.r][p.c]; // Current grid (termasuk path lain)
                    
                    // Cek Backtracking (Mundur ke diri sendiri)
                    const index = path.findIndex(pt => pt.r === p.r && pt.c === p.c);
                    if(index !== -1) {
                        // Potong path sampai sini
                        state.paths[state.currentPath] = path.slice(0, index+1);
                        updateGridFromPaths();
                        render();
                        return;
                    }
                    
                    // Cek Collision (Tabrakan)
                    // Boleh masuk jika: Target Kosong (0) ATAU Target adalah Endpoint warna sendiri
                    // DILARANG jika: Target adalah Path warna lain ATAU Endpoint warna lain
                    let allowed = false;
                    
                    // Kasus 1: Cell Kosong (di base & current)
                    if(targetBase === 0 && targetCurrent === 0) allowed = true;
                    
                    // Kasus 2: Cell adalah Endpoint SAYA SENDIRI
                    if(targetBase === state.currentPath) allowed = true;
                    
                    if(allowed) {
                        path.push({r: p.r, c: p.c});
                        updateGridFromPaths();
                        render();
                        checkWin();
                    }
                }
            }
        }

        function handleEnd() {
            if(state.currentPath) {
                state.moves++;
                document.getElementById('moves-display').innerText = state.moves;
                state.currentPath = null;
                checkWin();
            }
        }

        function isOutOfBounds(p) { return p.r < 0 || p.r >= gridSize || p.c < 0 || p.c >= gridSize; }

        function updateGridFromPaths() {
            const base = LEVELS[state.levelIdx].grid;
            // Reset grid
            for(let r=0; r<gridSize; r++) {
                for(let c=0; c<gridSize; c++) {
                    state.grid[r][c] = (base[r][c] > 0) ? 0 : 0; // Bersihkan path lama
                }
            }
            // Gambar ulang path
            for(const [colorId, path] of Object.entries(state.paths)) {
                path.forEach(pt => {
                    // Jangan timpa endpoint base
                
