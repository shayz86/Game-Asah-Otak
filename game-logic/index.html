<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Kubus Logika - Time Attack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #0f172a; touch-action: none; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* UI Layers */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .interactive { pointer-events: auto; cursor: pointer; }
        
        /* Glassmorphism Panels */
        .glass-panel {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        }

        /* Modals & Overlays */
        #overlay, #confirm-modal, #leaderboard-modal, #game-over-modal {
            position: absolute; inset: 0; z-index: 50;
            display: flex; align-items: center; justify-content: center;
            background-color: rgba(15, 23, 42, 0.98);
        }

        /* Timer Bar Animation */
        .timer-container { width: 100%; height: 6px; background: #334155; border-radius: 99px; overflow: hidden; margin-top: 8px; }
        .timer-fill { height: 100%; background: linear-gradient(90deg, #4ade80, #22c55e); transition: width 1s linear; }
        .timer-critical { background: #ef4444; animation: pulse 0.5s infinite; }
        
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }

        /* Scrollbar for Leaderboard */
        .scroller::-webkit-scrollbar { width: 4px; }
        .scroller::-webkit-scrollbar-track { background: #1e293b; }
        .scroller::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="ui-layer" class="flex flex-col justify-between p-4 h-full hidden">
        <div class="w-full max-w-lg mx-auto pointer-events-none">
            <div class="flex justify-between items-start text-white">
                <div>
                    <h1 class="text-xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500">KUBUS LOGIKA</h1>
                    <div class="flex items-baseline gap-2 mt-1">
                        <span class="text-xs text-gray-400">LEVEL</span>
                        <span id="hud-level" class="text-xl font-mono font-bold text-white">1</span>
                        <span class="text-xs text-gray-600">/ 50</span>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button id="reset-btn" class="interactive bg-red-600/20 hover:bg-red-600 text-red-400 hover:text-white px-3 py-2 rounded-lg border border-red-500/30 text-[10px] font-bold transition">
                        ULANG (R)
                    </button>
                    <button onclick="askExit()" class="interactive bg-slate-700/50 hover:bg-slate-600 text-white w-10 h-10 rounded-lg border border-slate-600 flex items-center justify-center transition">
                        ‚úï
                    </button>
                </div>
            </div>
            
            <div class="timer-container">
                <div id="timer-bar" class="timer-fill" style="width: 100%;"></div>
            </div>
            <p id="theme-name" class="text-[10px] text-gray-500 uppercase tracking-widest mt-1 text-center">Tema: Tutorial</p>
        </div>

        <div class="text-center pb-4 opacity-50 pointer-events-none">
            <p class="text-[10px] text-gray-400 uppercase tracking-widest">Swipe Layar untuk Bergerak</p>
        </div>
    </div>

    <div id="overlay">
        <div class="glass-panel p-8 rounded-3xl max-w-sm w-full mx-4 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-yellow-400 to-orange-500"></div>
            
            <h2 class="text-4xl font-black mb-2 text-white mt-2">LOGIKA</h2>
            <p class="text-gray-400 text-sm mb-6 font-light">Nyalakan semua lantai. Waktu terbatas!</p>
            
            <button onclick="startGame()" class="interactive w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-4 rounded-xl shadow-lg mb-3 transition transform active:scale-95">
                MULAI MAIN
            </button>
            
            <button onclick="showLeaderboard()" class="interactive w-full bg-slate-800 hover:bg-slate-700 text-yellow-400 font-bold py-3 rounded-xl border border-slate-700 mb-3 transition">
                üèÜ TOP SKOR
            </button>

            <a href="../index.html" class="interactive block w-full py-3 text-xs text-gray-500 hover:text-white transition">
                ‚¨Ö KEMBALI KE MENU UTAMA (REPO)
            </a>
        </div>
    </div>

    <div id="leaderboard-modal" class="hidden">
        <div class="glass-panel p-6 rounded-2xl max-w-sm w-full h-3/4 flex flex-col relative mx-4">
            <button onclick="hideLeaderboard()" class="interactive absolute top-4 right-4 text-gray-400 hover:text-white">‚úï</button>
            <h2 class="text-2xl font-bold text-yellow-400 mb-4 text-center border-b border-white/10 pb-4">TOP 10 RECORDS</h2>
            
            <div id="lb-list" class="flex-1 overflow-y-auto scroller space-y-2 pr-1">
                </div>
        </div>
    </div>

    <div id="confirm-modal" class="hidden">
        <div class="glass-panel p-6 rounded-2xl max-w-xs w-full text-center mx-4">
            <h3 class="text-xl font-bold text-white mb-2">Keluar Permainan?</h3>
            <p class="text-gray-400 text-xs mb-6">Progress level ini akan hilang.</p>
            <div class="flex gap-3">
                <button onclick="closeConfirm()" class="interactive flex-1 bg-slate-700 text-white py-2 rounded-lg text-sm">Batal</button>
                <button onclick="confirmExit()" class="interactive flex-1 bg-red-600 text-white py-2 rounded-lg font-bold text-sm shadow-lg">YA, KELUAR</button>
            </div>
        </div>
    </div>

    <div id="game-over-modal" class="hidden">
        <div class="glass-panel p-8 rounded-3xl max-w-sm w-full mx-4 text-center border-t-4 border-transparent" id="go-border">
            <h2 id="go-title" class="text-3xl font-black text-white mb-2">GAME OVER</h2>
            <p id="go-desc" class="text-gray-300 text-sm mb-6">Waktu Habis!</p>
            
            <button onclick="restartGame()" class="interactive w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg mb-3">
                MAIN LAGI
            </button>
            <button onclick="confirmExit()" class="interactive w-full bg-slate-700 text-white font-semibold py-3 rounded-xl">
                MENU AWAL
            </button>
        </div>
    </div>

    <div id="game-container"></div>

    <script>
        // --- LOGIKA BACK BUTTON HP ---
        // Mencegah back button keluar browser, ganti dengan popup konfirmasi
        history.pushState(null, null, location.href);
        window.onpopstate = function () {
            history.pushState(null, null, location.href);
            askExit();
        };

        // --- GLOBAL VARIABLES ---
        const TILE_SIZE = 1.2;
        const TOTAL_LEVELS = 50;
        const LB_KEY = 'kubus_logika_topscores';

        let scene, camera, renderer, playerMesh, tileMeshes = [];
        let currentLevelIndex = 0;
        let currentMap = [];
        let playerPos = { x: 0, z: 0 };
        let isMoving = false;
        let isGameActive = false;
        
        // Timer Vars
        let timerInterval = null;
        let timeLeft = 0;
        let maxTime = 0;

        // Input Vars
        let startMouse = { x: 0, y: 0 };

        // Theme Data
        const THEMES = [
            { name: "Neon City", bg: 0x0f172a, tile: 0x334155, on: 0xfacc15, player: 0x38bdf8, pEmit: 0x0ea5e9 },
            { name: "Mars Base", bg: 0x2a0a0a, tile: 0x552222, on: 0xff5500, player: 0xffaa00, pEmit: 0xff4400 },
            { name: "Cyber Jungle", bg: 0x052e16, tile: 0x14532d, on: 0x4ade80, player: 0x22d3ee, pEmit: 0x06b6d4 },
            { name: "Deep Ocean", bg: 0x0c0a2a, tile: 0x1e1b4b, on: 0x818cf8, player: 0xf472b6, pEmit: 0xe879f9 },
            { name: "Void Core", bg: 0x000000, tile: 0x262626, on: 0xffffff, player: 0xff0055, pEmit: 0xff0055 }
        ];

        // --- LEVEL GENERATOR ---
        const staticLevels = [
            { map: [[1,1,1],[1,1,1],[1,1,1]], start: {x:1, z:1} },
            { map: [[1,1,1],[0,1,0],[0,1,0],[0,1,0]], start: {x:1, z:3} },
            { map: [[1,0,1,1,1],[1,1,1,0,1],[0,0,1,1,1]], start: {x:0, z:0} },
            { map: [[1,1,1,1],[1,0,0,1],[1,0,0,1],[1,1,1,1]], start: {x:0, z:0} },
            { map: [[1,1,1,0,1],[1,0,1,0,1],[1,0,1,1,1],[1,0,0,0,0],[1,1,1,1,1]], start: {x:0, z:0} }
        ];
        let levels = [...staticLevels];

        // Generate levels 6-50 automatically
        for (let i = 5; i < TOTAL_LEVELS; i++) {
            const size = Math.min(8, 4 + Math.floor(i / 10)); 
            const minPath = 8 + i; 
            let map, startPos, success = false, attempts = 0;
            while(!success && attempts < 50) {
                attempts++;
                map = Array(size).fill().map(() => Array(size).fill(0));
                let curr = { x: Math.floor(Math.random()*(size-2))+1, y: Math.floor(Math.random()*(size-2))+1 };
                startPos = { ...curr };
                map[curr.y][curr.x] = 1;
                let pathLen = 1;
                for(let steps=0; steps<minPath*1.5; steps++) {
                    let dirs = [{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0}];
                    let d = dirs[Math.floor(Math.random()*4)];
                    let nx = curr.x+d.x, ny = curr.y+d.y;
                    if(nx>=0 && nx<size && ny>=0 && ny<size) {
                        if(map[ny][nx]===0) pathLen++;
                        map[ny][nx] = 1;
                        curr = {x:nx, y:ny};
                    }
                }
                if(pathLen >= minPath) success = true;
            }
            levels.push({ map: map, start: {x: startPos.x, z: startPos.y} });
        }

        // --- LEADERBOARD SYSTEM ---
        function saveScore(lvl) {
            let data = JSON.parse(localStorage.getItem(LB_KEY) || '[]');
            let date = new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'short'});
            // Cek apakah user ini sudah ada record? (Disini kita simpan history saja)
            data.push({ l: lvl, d: date });
            // Sort by level desc
            data.sort((a, b) => b.l - a.l);
            // Keep top 10
            data = data.slice(0, 10);
            localStorage.setItem(LB_KEY, JSON.stringify(data));
        }

        function showLeaderboard() {
            const list = document.getElementById('lb-list');
            const data = JSON.parse(localStorage.getItem(LB_KEY) || '[]');
            
            if(data.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 mt-10 text-xs">Belum ada rekor tersimpan.</div>';
            } else {
                let html = '';
                data.forEach((item, idx) => {
                    let color = idx === 0 ? 'text-yellow-400' : (idx===1?'text-gray-300':(idx===2?'text-orange-400':'text-white'));
                    let bg = idx % 2 === 0 ? 'bg-white/5' : 'bg-transparent';
                    html += `
                        <div class="flex justify-between items-center p-3 rounded-lg ${bg}">
                            <div class="flex items-center gap-3">
                                <span class="font-mono font-bold w-6 ${color}">#${idx+1}</span>
                                <span class="text-xs text-gray-400">${item.d}</span>
                            </div>
                            <span class="font-bold text-emerald-400 text-sm">Lv. ${item.l}</span>
                        </div>`;
                });
                list.innerHTML = html;
            }
            document.getElementById('leaderboard-modal').classList.remove('hidden');
        }

        function hideLeaderboard() {
            document.getElementById('leaderboard-modal').classList.add('hidden');
        }

        // --- UI & NAVIGATION ---
        function startGame() {
            document.getElementById('overlay').classList.add('hidden');
            document.getElementById('ui-layer').classList.remove('hidden');
            currentLevelIndex = 0;
            loadLevel(0);
            isGameActive = true;
        }

        function askExit() {
            if(!isGameActive) return; // Jangan muncul di menu utama
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function closeConfirm() {
            document.getElementById('confirm-modal').classList.add('hidden');
        }

        function confirmExit() {
            // Reset state
            isGameActive = false;
            clearInterval(timerInterval);
            
            // Hide everything
            document.getElementById('confirm-modal').classList.add('hidden');
            document.getElementById('game-over-modal').classList.add('hidden');
            document.getElementById('ui-layer').classList.add('hidden');
            
            // Show Start Overlay
            document.getElementById('overlay').classList.remove('hidden');
        }

        function restartGame() {
            document.getElementById('game-over-modal').classList.add('hidden');
            currentLevelIndex = 0;
            loadLevel(0);
            isGameActive = true;
        }

        // --- THREE.JS ENGINE ---
        function init() {
            const container = document.getElementById('game-container');
            scene = new THREE.Scene();
            
            // KAMERA STATIS (Fixed Isometric)
            const aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.PerspectiveCamera(45, aspect, 0.1, 100);
            camera.position.set(10, 10, 10); // Standard Isometric View
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            const ambient = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambient);
            const sun = new THREE.DirectionalLight(0xffffff, 0.8);
            sun.position.set(5, 15, 5);
            sun.castShadow = true;
            scene.add(sun);

            window.addEventListener('resize', onWindowResize, false);
            setupInputHandlers();
            animate();
        }

        function loadLevel(idx) {
            if(idx >= TOTAL_LEVELS) {
                gameOver(true); 
                return; 
            }

            // Cleanup
            if(playerMesh) scene.remove(playerMesh);
            tileMeshes.forEach(m => scene.remove(m));
            tileMeshes = [];

            const levelData = levels[idx];
            currentMap = JSON.parse(JSON.stringify(levelData.map));
            playerPos = { ...levelData.start };
            
            // Theme
            const theme = THEMES[Math.floor(idx / 10) % THEMES.length];
            scene.background = new THREE.Color(theme.bg);
            document.getElementById('theme-name').innerText = "TEMA: " + theme.name;
            document.getElementById('theme-name').style.color = '#' + theme.on.toString(16);

            // Create Grid
            const h = currentMap.length; 
            const w = currentMap[0].length;
            const offX = (w*TILE_SIZE)/2 - (TILE_SIZE/2);
            const offZ = (h*TILE_SIZE)/2 - (TILE_SIZE/2);
            const geo = new THREE.BoxGeometry(TILE_SIZE*0.9, 0.2, TILE_SIZE*0.9);
            
            let tileCount = 0;

            for(let z=0; z<h; z++) {
                for(let x=0; x<w; x++) {
                    if(currentMap[z][x] !== 0) {
                        tileCount++;
                        const mat = new THREE.MeshStandardMaterial({ color: theme.tile, roughness:0.2 });
                        const tile = new THREE.Mesh(geo, mat);
                        tile.position.set((x*TILE_SIZE)-offX, -0.1, (z*TILE_SIZE)-offZ);
                        tile.userData = { gridX: x, gridZ: z, state: false, colorOn: theme.on, colorOff: theme.tile };
                        tile.receiveShadow = true;
                        scene.add(tile);
                        tileMeshes.push(tile);
                    }
                }
            }

            // Player
            const pGeo = new THREE.SphereGeometry(TILE_SIZE*0.35, 32, 32);
            const pMat = new THREE.MeshStandardMaterial({ color: theme.player, emissive: theme.player, emissiveIntensity: 0.5 });
            playerMesh = new THREE.Mesh(pGeo, pMat);
            playerMesh.castShadow = true;
            const startTile = getTileMesh(playerPos.x, playerPos.z);
            if(startTile) {
                playerMesh.position.copy(startTile.position);
                playerMesh.position.y = TILE_SIZE*0.5;
                toggleTile(startTile, true);
            }
            scene.add(playerMesh);

            // Camera Zoom Adjustment
            const maxDim = Math.max(w, h);
            const zoom = 9 + (maxDim * 1.5);
            camera.position.set(zoom, zoom, zoom);
            camera.lookAt(0,0,0);

            // Update UI
            document.getElementById('hud-level').innerText = (idx + 1);

            // TIMER LOGIC: Difficulty increases with level
            // Base time per tile reduces as level goes up
            let secondsPerTile = Math.max(0.4, 1.2 - (idx * 0.015)); 
            let totalTime = Math.floor(tileCount * secondsPerTile) + 4; // +4s buffer
            
            startTimer(totalTime);
        }

        function startTimer(seconds) {
            clearInterval(timerInterval);
            maxTime = seconds;
            timeLeft = seconds;
            
            updateTimerUI();
            
            timerInterval = setInterval(() => {
                if(!isGameActive) return;
                timeLeft--;
                updateTimerUI();
                
                if(timeLeft <= 0) {
                    gameOver(false);
                }
            }, 1000);
        }

        function updateTimerUI() {
            const bar = document.getElementById('timer-bar');
            let pct = (timeLeft / maxTime) * 100;
            bar.style.width = pct + "%";
            
            if(pct < 30) bar.classList.add('timer-critical');
            else bar.classList.remove('timer-critical');
        }

        function gameOver(win) {
            isGameActive = false;
            clearInterval(timerInterval);
            
            const modal = document.getElementById('game-over-modal');
            const title = document.getElementById('go-title');
            const desc = document.getElementById('go-desc');
            const border = document.getElementById('go-border');
            
            modal.classList.remove('hidden');

            // Save Score (Max Level reached)
            // If win=false, score is current level index (already passed prev).
            // If win=true (finished all), score is 50.
            let scoreToSave = win ? 50 : (currentLevelIndex + 1);
            saveScore(scoreToSave);

            if(win) {
                border.style.borderColor = "#facc15"; // Yellow
                title.innerText = "TAMAT!";
                title.className = "text-3xl font-black text-yellow-400 mb-2";
                desc.innerText = "Selamat! Kamu Master Logika.";
            } else {
                border.style.borderColor = "#ef4444"; // Red
                title.innerText = "WAKTU HABIS";
                title.className = "text-3xl font-black text-red-500 mb-2";
                desc.innerText = "Level " + (currentLevelIndex + 1) + " Gagal. Coba lagi!";
            }
        }

        function getTileMesh(gx, gz) { return tileMeshes.find(t => t.userData.gridX === gx && t.userData.gridZ === gz); }
        
        function toggleTile(tile, forceOn=false) {
            if (!tile) return;
            tile.userData.state = !tile.userData.state;
            if(forceOn) tile.userData.state = true;
            
            const isOn = tile.userData.state;
            tile.material.color.setHex(isOn ? tile.userData.colorOn : tile.userData.colorOff);
            tile.material.emissive.setHex(isOn ? tile.userData.colorOn : 0x000000);
            tile.material.emissiveIntensity = isOn ? 0.6 : 0;
            
            if(isOn) {
                let f=0;
                const anim = () => { if(f<5) { tile.position.y -= 0.05; f++; requestAnimationFrame(anim); } else tile.position.y = -0.1; };
                anim();
            }
        }

        function checkWin() {
            const all = tileMeshes.length;
            const active = tileMeshes.filter(t => t.userData.state).length;
            if(active === all) {
                clearInterval(timerInterval);
                setTimeout(() => {
                    currentLevelIndex++;
                    loadLevel(currentLevelIndex);
                }, 500);
            }
        }

        function move(dx, dz) {
            if(isMoving || !isGameActive) return;
            
            const nx = playerPos.x + dx;
            const nz = playerPos.z + dz;
            const targetTile = getTileMesh(nx, nz);
            
            if(!targetTile) return; // Hit wall
            
            // Aturan: Jangan injak lantai emas 2 kali
            if(targetTile.userData.state === true) {
                gameOver(false); // Kalah karena injak 2x
                return;
            }

            isMoving = true;
            playerPos.x = nx; playerPos.z = nz;
            
            const pStart = playerMesh.position.clone();
            const pEnd = targetTile.position.clone(); pEnd.y = TILE_SIZE*0.5;
            
            let t=0;
            const anim = () => {
                t += 0.15; if(t>1) t=1;
                playerMesh.position.lerpVectors(pStart, pEnd, t);
                playerMesh.position.y = (TILE_SIZE*0.5) + Math.sin(t*Math.PI)*0.8;
                
                if(t<1) requestAnimationFrame(anim);
                else {
                    isMoving=false;
                    playerMesh.position.y = TILE_SIZE*0.5;
                    toggleTile(targetTile);
                    checkWin();
                }
            };
            anim();
        }

        function setupInputHandlers() {
            const c = document.getElementById('game-container');
            
            // Touch Swipe
            c.addEventListener('touchstart', e => { startMouse.x = e.touches[0].clientX; startMouse.y = e.touches[0].clientY; }, {passive:false});
            c.addEventListener('touchend', e => {
                const dx = e.changedTouches[0].clientX - startMouse.x;
                const dy = e.changedTouches[0].clientY - startMouse.y;
                
                // Camera is fixed isometric:
                // Swipe Up (Screen) -> Z- (Move Up/Left in grid relative to screen look)
                // Simplified: Logic swipe mengikuti visual di layar
                if(Math.abs(dx) > Math.abs(dy)) {
                    if(Math.abs(dx) > 30) move(dx > 0 ? 1 : -1, 0); 
                } else {
                    if(Math.abs(dy) > 30) move(0, dy > 0 ? 1 : -1);
                }
            }, {passive:false});

            // Keyboard
            document.addEventListener('keydown', e => {
                if(!isGameActive) return;
                if(e.key === 'r') loadLevel(currentLevelIndex);
                if(e.key === 'ArrowUp' || e.key === 'w') move(0, -1);
                if(e.key === 'ArrowDown' || e.key === 's') move(0, 1);
                if(e.key === 'ArrowLeft' || e.key === 'a') move(-1, 0);
                if(e.key === 'ArrowRight' || e.key === 'd') move(1, 0);
            });

            // Reset Button
            document.getElementById('reset-btn').addEventListener('click', () => {
                if(isGameActive) loadLevel(currentLevelIndex);
            });
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            if(playerMesh && !isMoving) {
                playerMesh.position.y = (TILE_SIZE*0.5) + Math.sin(Date.now()*0.003)*0.05;
            }
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
